# /backend/project_nginx.conf (Production Ready)

# Upstream for Gunicorn (WSGI - synchronous HTTP)
upstream gunicorn_server {
    server unix:/tmp/gunicorn.sock fail_timeout=0;
}

# Upstream for Daphne (ASGI - WebSockets and async HTTP)
upstream daphne_server {
    server unix:/tmp/daphne.sock fail_timeout=0;
}

server {
    listen 80 default_server;
    server_name _; # Will be effectively ignored as Cloudflare handles public domain routing

    # === LOGGING ===
    # Send Nginx access and error logs to stdout and stderr to be captured by Supervisor/Docker/ECS
    access_log /dev/stdout;
    error_log /dev/stderr info; # Or 'warn' or 'error' for less verbosity

    # === BODY SIZE ===
    # Adjust to your needs for file uploads
    client_max_body_size 25M;

    # === SECURITY HEADERS ===
    # Add these within the server block or http block if you have one.
    # Ensure these are appropriate for your application.
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always; # A more common modern default
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always; # Example CSP, VERY CAREFUL, needs tailoring
    # HSTS: Only enable if HTTPS is consistently enforced up to this Nginx instance (e.g., via X-Forwarded-Proto)
    # and you understand the implications of preloading. Cloudflare will also handle HSTS.
    # If Cloudflare handles HSTS, you might not need it here, or ensure they don't conflict.
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;


    # === STATIC AND MEDIA FILES ===
    location /static/ {
        alias /app/staticfiles/; # Matches Dockerfile APP_HOME and collectstatic output
        expires 30d;
        add_header Cache-Control "public";
        access_log off; # Optional: turn off access logs for static files
    }

    location /media/ {
        alias /app/media/; # Matches Dockerfile APP_HOME
        expires 30d;
        add_header Cache-Control "public";
        access_log off; # Optional: turn off access logs for media files
    }

    # === WEBSOCKETS for Django Channels ===
    # Assumes your Channels routing is under a path like /ws/
    location /ws/ {
        proxy_pass http://daphne_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Important: ensure $scheme is correctly set (e.g. by Cloudflare or ALB)
        proxy_set_header X-Forwarded-Host $server_name;
        # proxy_read_timeout 86400s; # Consider increasing timeout for long-lived WebSockets
        # proxy_send_timeout 86400s;
    }

    # === Main Application Proxy to Gunicorn ===
    location / {
        proxy_pass http://gunicorn_server;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Crucial for Django to recognize HTTPS
        proxy_set_header X-Forwarded-Host $server_name;

        # Optional: Increase proxy buffer sizes if you encounter issues
        # proxy_buffers 8 16k;
        # proxy_buffer_size 32k;
    }

    # Deny access to hidden files (e.g., .htaccess, .git)
    location ~ /\. {
        deny all;
    }
}