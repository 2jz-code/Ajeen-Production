# /backend/project_nginx.conf

# Upstream for Gunicorn (WSGI - synchronous HTTP)
upstream gunicorn_server {
    # Gunicorn will listen on a Unix socket or a TCP port within the container
    # Using a Unix socket is common for processes in the same container
    server unix:/tmp/gunicorn.sock fail_timeout=0;
    # Alternatively, if Gunicorn listens on a TCP port (e.g., 8001):
    # server 127.0.0.1:8001 fail_timeout=0;
}

# Upstream for Daphne (ASGI - WebSockets and async HTTP)
upstream daphne_server {
    # Daphne will listen on a different Unix socket or TCP port
    server unix:/tmp/daphne.sock fail_timeout=0;
    # Alternatively, if Daphne listens on a TCP port (e.g., 8002):
    # server 127.0.0.1:8002 fail_timeout=0;
}

server {
    listen 80 default_server; # Nginx will listen on port 80 inside the container
    server_name _; # Catch-all server name

    # Path to Django static files (collected by collectstatic)
    # This should match STATIC_ROOT in your Django settings, prepended by APP_HOME
    location /static/ {
        alias /app/staticfiles/; # Make sure '/app' matches APP_HOME in Dockerfile
        expires 30d;
        add_header Cache-Control "public";
    }

    # Path to Django media files (user-uploaded content)
    # This should match MEDIA_ROOT in your Django settings, prepended by APP_HOME
    location /media/ {
        alias /app/media/; # Make sure '/app' matches APP_HOME in Dockerfile
        expires 30d;
        add_header Cache-Control "public";
    }

    # Handle WebSocket connections for Django Channels
    # Ensure your Channels routing is under a path like /ws/
    location /ws/ {
        proxy_pass http://daphne_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }

    # Proxy all other HTTP requests to Gunicorn
    location / {
        proxy_pass http://gunicorn_server;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme; # Important for HTTPS detection by Django
        proxy_set_header X-Forwarded-Host $server_name;

        # Increase proxy buffer sizes if you encounter issues with large requests/responses
        # proxy_buffers 8 16k;
        # proxy_buffer_size 32k;
        # proxy_connect_timeout 240;
        # proxy_send_timeout 240;
        # proxy_read_timeout 240;
    }

    # Optional: Deny access to hidden files (e.g., .htaccess, .git)
    location ~ /\. {
        deny all;
    }

    # Optional: Add security headers
    # add_header X-Frame-Options "SAMEORIGIN" always;
    # add_header X-Content-Type-Options "nosniff" always;
    # add_header X-XSS-Protection "1; mode=block" always;
    # add_header Referrer-Policy "same-origin" always;
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; # Only if HTTPS is enforced
}